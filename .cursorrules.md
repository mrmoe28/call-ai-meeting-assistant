# CallAI Project - Cursor Rules & Special Instructions

## 🚨 CRITICAL: DOCUMENTATION PRIORITY RULE

**ALWAYS REFERENCE THIS FILE FIRST** before searching the web or external sources.

### Documentation Priority Order:
1. **FIRST**: This `.cursorrules.md` file and project documentation
2. **SECOND**: Local project files and established patterns
3. **THIRD**: Web search only if local documentation is insufficient

---

## 📋 Project Overview

**CallAI** is a macOS meeting assistant app built with SwiftUI that records, transcribes, and summarizes meetings using AI.

### Core Technologies:
- **SwiftUI**: Modern declarative UI framework
- **SwiftData**: Data persistence (replaces Core Data)
- **AVFoundation**: Audio recording and microphone access
- **OpenAI APIs**: Whisper (transcription) + GPT-4o-mini (summarization)
- **EventKit**: Calendar integration
- **Keychain**: Secure API key storage

### Bundle Identifier: `ekodev.callai`

---

## 🎯 Swift API Design Guidelines

### Core Principles:
1. **Clarity at the point of use** - Code should be self-documenting
2. **Consistency** - Follow established patterns throughout the codebase
3. **Conciseness** - Prefer brevity without sacrificing clarity

### Naming Conventions:
- **Types**: PascalCase (`AudioRecordingService`, `Meeting`)
- **Functions**: camelCase with verb (`startRecording`, `checkPermission`)
- **Properties**: camelCase (`isRecording`, `authorizationStatus`)
- **Constants**: camelCase (`appName`, `apiEndpoint`)

### Method Design:
- **Boolean methods**: Use `is`, `has`, `can` prefixes (`isRecording`, `hasPermission`)
- **Void methods**: Use imperative verbs (`startRecording`, `stopRecording`)
- **Returning methods**: Use noun phrases (`getCurrentDevice`, `createMeeting`)

### Error Handling:
```swift
// Use Result types for operations that can fail
func startRecording() async -> Result<URL, RecordingError>

// Use throwing functions for synchronous operations
func validateMeeting(_ meeting: Meeting) throws

// Use custom error enums
enum RecordingError: LocalizedError {
    case permissionDenied
    case deviceUnavailable
    case fileWriteFailed
}
```

---

## 🎨 Design System Guidelines

### Color System:
```swift
// Use AppColor for consistent theming
AppColor.primary        // Main brand color
AppColor.surface        // Background surfaces
AppColor.surfaceElevated // Elevated surfaces (cards)
AppColor.accent         // Accent color for highlights
```

### Typography:
```swift
// Use AppFont for consistent text styling
AppFont.title1          // Large titles
AppFont.headline        // Section headers
AppFont.body            // Body text
AppFont.caption         // Small text
```

### Spacing & Layout:
```swift
// Use AppSpacing for consistent spacing
AppSpacing.sectionSpacing    // Between major sections
AppSpacing.cardSpacing       // Between cards
AppSpacing.elementSpacing    // Between UI elements
```

### Components:
```swift
// Use AppComponents for reusable UI elements
AppButton.primary       // Primary action button
AppButton.secondary     // Secondary action button
AppCard.standard        // Standard card container
```

---

## 🎤 AVFoundation Guidelines

### Microphone Permission Handling:
```swift
// Always check permission status first
let status = AVCaptureDevice.authorizationStatus(for: .audio)

// Request permission with proper error handling
AVCaptureDevice.requestAccess(for: .audio) { granted in
    DispatchQueue.main.async {
        // Update UI on main thread
    }
}
```

### Device Selection (macOS):
```swift
// Enumerate available audio devices
let discovery = AVCaptureDevice.DiscoverySession(
    deviceTypes: [.microphone, .external],
    mediaType: .audio,
    position: .unspecified
)

// Handle device selection
func selectDevice(withUniqueID id: String) {
    selectedDeviceUniqueID = id
    // Update audio session configuration
}
```

### Recording Best Practices:
```swift
// Always capture and use return values
let recordingURL = await audioService.startRecording(for: meeting)
if let url = recordingURL {
    print("Recording started at: \(url)")
}

// Handle recording errors gracefully
do {
    try audioRecorder.start()
} catch {
    // Show user-friendly error message
}
```

---

## 🔧 macOS-Specific Guidelines

### App Sandboxing:
- **Required Entitlements**: `com.apple.security.device.microphone`
- **Info.plist**: Must include `NSMicrophoneUsageDescription`
- **Permission Flow**: Use `AVCaptureDevice.requestAccess(for: .audio)`

### System Integration:
```swift
// Open System Settings for permissions
if let url = URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_Microphone") {
    NSWorkspace.shared.open(url)
}

// Register app with LaunchServices
lsregister -f -R -trusted /path/to/app.app
```

### Permission Troubleshooting:
1. **Reset permissions**: `tccutil reset Microphone ekodev.callai`
2. **Force permission request**: Use `forcePermissionRequest()` method
3. **Check System Settings**: Ensure app appears in microphone list
4. **Rebuild app**: Clean build to refresh app registration

---

## 🏗️ Code Organization

### File Structure:
```
callai/
├── callaiApp.swift              # App entry point
├── ContentView.swift            # Main tab navigation
├── RecordingView.swift          # Recording interface
├── AudioRecordingService.swift  # Audio handling
├── TranscriptionService.swift   # OpenAI Whisper integration
├── AISummaryService.swift       # OpenAI GPT integration
├── CalendarService.swift        # EventKit integration
├── Design/
│   ├── AppDesignTokens.swift    # Design system
│   └── AppComponents.swift      # Reusable components
└── Views/
    ├── CalendarView.swift       # Calendar interface
    ├── SettingsView.swift       # App settings
    └── TranscriptsView.swift    # Transcript management
```

### State Management:
```swift
// Use @StateObject for service classes
@StateObject private var audioService = AudioRecordingService()

// Use @Published for reactive properties
@Published var isRecording = false
@Published var authorizationStatus: RecordingPermissionStatus = .undetermined

// Use @Binding for parent-child communication
@Binding var selectedTab: Int
```

---

## 🚀 SwiftUI Best Practices

### View Composition:
```swift
// Break complex views into computed properties
private var permissionView: some View {
    Group {
        if !checkRecordingPermission() {
            if audioService.authorizationStatus == .denied {
                deniedPermissionView
            } else {
                undeterminedPermissionView
            }
        }
    }
}
```

### Performance:
```swift
// Use LazyVStack for large lists
LazyVStack(spacing: AppSpacing.sectionSpacing) {
    // Content
}

// Use @State for local view state
@State private var showingCustomMeeting = false
```

### Accessibility:
```swift
// Add accessibility labels
.accessibilityLabel("Start recording")
.accessibilityHint("Tap to begin recording the meeting")

// Support Dynamic Type
.font(AppFont.body)
```

---

## 🔒 Security Guidelines

### API Key Management:
```swift
// Store API keys in Keychain
KeychainManager.shared.store(apiKey, for: "openai_api_key")

// Never hardcode sensitive data
let apiKey = KeychainManager.shared.retrieve(for: "openai_api_key")
```

### Data Privacy:
- **Local Storage**: Use SwiftData for meeting data
- **Transcription**: Process audio locally when possible
- **API Calls**: Only send necessary data to external services

---

## 🧪 Testing Guidelines

### Unit Tests:
```swift
// Test permission handling
func testMicrophonePermissionRequest() async {
    let service = AudioRecordingService()
    await service.requestRecordingPermission()
    // Assert expected behavior
}
```

### UI Tests:
```swift
// Test permission flow
func testPermissionDeniedFlow() {
    // Simulate denied permission
    // Verify UI shows correct state
}
```

---

## 📱 Platform-Specific Code

### macOS vs iOS:
```swift
#if os(macOS)
// macOS-specific code
let discovery = AVCaptureDevice.DiscoverySession(
    deviceTypes: [.microphone, .external],
    mediaType: .audio,
    position: .unspecified
)
#else
// iOS-specific code
let session = AVAudioSession.sharedInstance()
#endif
```

### Navigation:
```swift
#if os(iOS)
.navigationBarTitleDisplayMode(.inline)
#endif
```

---

## 🐛 Common Issues & Solutions

### Microphone Permission Issues:
1. **App not in System Settings**: Rebuild and relaunch app
2. **Permission stuck**: Use `tccutil reset Microphone ekodev.callai`
3. **RØDECaster not detected**: Check device selection in app

### Build Issues:
1. **Type-checking timeout**: Break complex expressions into computed properties
2. **Unused result warnings**: Capture return values with `_` or use them
3. **Deprecated APIs**: Use modern alternatives (e.g., `NSWorkspace.shared.openApplication`)

### SwiftData Issues:
1. **Model changes**: Update schema version
2. **Migration errors**: Handle gracefully with fallback containers

---

## 🎯 Performance Guidelines

### Memory Management:
```swift
// Use weak references in closures
AVCaptureDevice.requestAccess(for: .audio) { [weak self] granted in
    Task { @MainActor in
        self?.authorizationStatus = granted ? .granted : .denied
    }
}
```

### Async/Await:
```swift
// Use async/await for network calls
func transcribeAudio(_ url: URL) async throws -> String {
    let response = try await whisperService.transcribe(audioURL: url)
    return response.text
}
```

---

## 🔄 Future Considerations

### Planned Features:
- **Real-time transcription**: Live meeting transcription
- **Multi-language support**: Internationalization
- **Cloud sync**: iCloud integration for transcript storage
- **Export formats**: PDF, Word, and other formats

### Technical Debt:
- **Error handling**: Standardize error types across services
- **Testing**: Increase test coverage
- **Documentation**: Add inline documentation for complex methods

---

## 📚 Special Instructions for AI Assistant

### When Fixing Issues:
1. **Always check this file first** for established patterns
2. **Follow the design system** - use AppColor, AppFont, AppSpacing
3. **Handle errors gracefully** - show user-friendly messages
4. **Test on macOS** - ensure compatibility with macOS-specific APIs
5. **Update documentation** - keep this file current with new patterns

### Code Quality Standards:
- **No force unwrapping** (`!`) - use safe unwrapping with `guard let`
- **Consistent naming** - follow Swift API Design Guidelines
- **Proper error handling** - use Result types or throwing functions
- **Accessibility** - add labels and hints for VoiceOver
- **Performance** - use LazyVStack for large lists, avoid unnecessary re-renders

### Microphone Permission Best Practices:
1. **Always request permission explicitly** using `AVCaptureDevice.requestAccess(for: .audio)`
2. **Provide clear user guidance** when permission is denied
3. **Offer multiple ways to grant permission** (in-app + System Settings)
4. **Handle device selection** for external microphones (RØDECaster, etc.)
5. **Test with different audio devices** to ensure compatibility

### App Icon Requirements:
- **Create all required sizes** (16x16 to 1024x1024)
- **Use modern design** with clear visual hierarchy
- **Include "AI" branding** to reflect the app's purpose
- **Test visibility** at small sizes (16x16, 32x32)

---

## 🎉 Success Criteria

### Microphone Permission:
- ✅ App appears in System Settings microphone list
- ✅ Permission dialog appears when requested
- ✅ External devices (RØDECaster) are detected and selectable
- ✅ Permission status updates correctly in UI

### App Icon:
- ✅ All required sizes generated and configured
- ✅ Icon appears in Dock and System Settings
- ✅ Clear visual identity for the app

### Code Quality:
- ✅ No compilation errors or warnings
- ✅ Follows established design patterns
- ✅ Proper error handling throughout
- ✅ Accessible to users with disabilities

---

*Last Updated: September 2024*
*Version: 1.0*

